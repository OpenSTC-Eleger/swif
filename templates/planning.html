<div class="page-header">
	<h1><%= lang.viewsTitles.planning %></h1>
</div>




<!-- Interventions List -->
<div class="row-fluid">


 	<!-- Left Column -->
 	<div class="span3">



		<!-- Interventions toolbar -->
		<div id="planningToolbar" class="row-fluid">

			<!-- Button add intervention -->
			<button class="btn btn-primary no-outline addInterventionPlanning pull-left">
				<i class="icon-plus"></i> <%= _.capitalize(lang.actions.addIntervention) %>
			</button>

			<!-- Filter -->
			<div class="dropdown span5 offset1">

				<a id="filterStateIntervention" class="dropdown-toggle filter-button" data-toggle="dropdown" href="#">
			   		<i class="icon-filter icon-large"> <%= _.capitalize(lang.status) %></i>
				</a>

				<ul id="filterStateInterventionList" class="dropdown-menu" aria-labelledby="filterStateIntervention">

					<% _.each(interventionsState, function (state, i) {
						if(i == app.Models.Intervention.status.scheduled.key || i == app.Models.Intervention.status.open.key || i == app.Models.Intervention.status.pending.key || i == app.Models.Intervention.status.template.key){
					%>
						<li>
							<a tabindex="-1" href="#<%= state.key %>">
								<i class="badge badge-<%= state.color %>">&nbsp;</i>
								&nbsp; <%= _.capitalize(state.translation) %>
							</a>
						</li>
					<% }
					}) %>
						<li class="divider"></li>
						<li class="delete-filter disabled"><a href="#delete-filter"><%= _.capitalize(lang.deleteFilter) %></a></li>
				</ul>
			</div>
			<br />
		</div>
		<!-- /Interventions toolbar -->



		<!-- Interventions List -->
		<% if( _.size(interventions) > 0 ) { %>
		
		<div class="accordion" id="accordionInter" style="overflow-y: scroll; max-height: 725px; margin-bottom: 0;">

			<!-- State Color -  To Schedule - Scheduled - Template-->
			<% _.each(interventions, function (intervention, i) { 
				var informationHour	= '';

				var classColor = app.Models.Intervention.status[intervention.state].color;

				if(intervention.state != app.Models.Intervention.status.template.key){
					informationHour = (intervention.planned_hours != false ? app.decimalNumberToTime(intervention.planned_hours, 'human') : '');
				}
				else{
					informationHour = (intervention.total_hours != false ? app.decimalNumberToTime(intervention.total_hours, 'human') : '');
				}


				if(intervention.description != false){
					var description = "<i class='icon-flag'></i>&nbsp; "+intervention.description+"<br />";
				}
				else{
					var description = "";
				}

				var popoverContent = description+ "<i class='icon-map-marker'></i>&nbsp; "+intervention.site1[1];
			%>
				<div class="accordion-group">
					<div class="accordion-heading border-emphasize border-emphasize-<%= classColor %>">
						<a href="#collapse_<%= intervention.id %>" class="accordion-toggle no-outline" 
						   data-toggle="collapse" data-parent="#accordionInter"  
						   rel="popover" data-placement="right" data-html="true" data-title="<%= intervention.name %>"
						   data-content="<%= popoverContent %>" >

							<i class="icon-pushpin">&nbsp;&nbsp;</i><span><%= _(intervention.name).truncate(25) %></span>

							<!-- Intervention Actions -->
							<button class="btn btn-link invisible linkToInter" type="button" data-toggle="modal" rel="tooltip" data-original-title="<%= _.capitalize(lang.actions.update) %>" data-placement="top" data-delay="50"><i class="icon-pencil"></i></button>	
							
							<% if(intervention.state == app.Models.Intervention.status.open.key || intervention.state == app.Models.Intervention.status.scheduled.key) { %>
								<button data-target="#modalCancelInter" class="btn btn-link buttonCancelInter invisible" data-toggle="modal" rel="tooltip" data-original-title="<%= _.capitalize(lang.actions.cancel) %>" data-placement="top" data-delay="50"><i class="icon-ban-circle"></i></button>
							<% } %>

							<small class="badge badge-<%= classColor %> pull-right"><%= informationHour %></small>
						</a>
					</div>

					<div id="collapse_<%= intervention.id %>" class="accordion-body collapse border-emphasize border-emphasize-<%= classColor %>">
						<div class="accordion-inner">

							<!-- Check if there is some tasks -->
							<% if(intervention.tasks.length != 0) { %>

								<!-- Display all task of the Intervention -->
								<ul class="unstyled tasks">
								<% 
									var allPlanned = true;
									_.each(intervention.tasks, function (task, i) { %>

										<!-- To Schedule -->
										<% if(task.state == app.Models.Task.status.draft.key) { %>
										<li id="task_<%= task.id %>" class="external-event">
											<i class="icon-chevron-right"></i> <%= task.name %>

											<a href="#modalDeleteTask" class="modalDeleteTask hide" data-toggle="modal">
												<i class="icon-remove displayInlineBlock modalDeleteTask" rel="tooltip" data-original-title="<%= _.capitalize(lang.actions.delete) %>" data-placement="top" data-delay="50">&nbsp;</i>
											</a>

											<small class="badge badge-<%= app.Models.Task.status.draft.color %> pull-right"><%= task.planned_hours %>h</small>
										</li>

										<!-- Schedule -->
										<% allPlanned = false;

										} else if(task.state == app.Models.Task.status.open.key){ %>
										<li id="task_<%= task.id %>" class="external-event disabled">
											<i class="icon-time" rel="tooltip" data-placement="right" data-original-title="<%= moment(task.date_start).format('LLL') %> - <%= (task.team_id == false ? task.user_id[1] : task.team_id[1]) %>"></i> <%= task.name %>
											<small class="badge badge-<%= app.Models.Task.status.open.color %> pull-right"><%= app.decimalNumberToTime(task.planned_hours, 'human') %></small>
										</li>
										<% } %>

								<%	}); %>
							<% } else { %>

								<!-- No task to display -->
								<div class="alert alert-info">
									<i class="icon-info-sign icon-large"></i> &nbsp;<%= lang.infoMessages.noTaskForIntervention %>.

								</div>
							<% } %>
							</ul>

							<!-- Intervention Action -->
							<div class="div-actions">

								<!-- Add Task -->
								<button class="btn btn-primary btn-small no-outline addTaskPlanning" id="<%= intervention.id %>" rel="tooltip" 
										data-original-title="<%= _.capitalize(lang.actions.addTask) %>" data-placement="right"
									<% if(intervention.state != app.Models.Intervention.status.open.key &&
											intervention.state != app.Models.Intervention.status.pending.key &&
											intervention.state != app.Models.Intervention.status.template.key) { %>
										disabled
									<% } %>>
									<i class="icon-plus"></i>
								</button>

								<!-- Switch button - To Scheduled / Scheduled -->
								<% if(_.size(intervention.tasks) > 0 && intervention.state != app.Models.Intervention.status.template.key) { %>

									<div class="switch switch-small calendarSwitch pull-right" data-on-label="<%= _.capitalize(lang.planningFenced) %>" data-off-label="<%= _.capitalize(lang.toScheduled) %>" data-on="primary" data-off="warning">

										<input type="checkbox" 
											<% if(intervention.state == app.Models.Intervention.status.scheduled.key){ %>
												checked
											<% } %>

											<% if(allPlanned == false){ %>
												disabled
											 <% } %>
											/>
									</div>

								<% } %>
							</div>

						</div>
					</div>
				</div>
			<% }) %>

		</div>
		<% }else { %>

			<!-- No interventions to display -->
			<div class="alert alert-info">
				<i class="icon-info-sign icon-large"></i> &nbsp;<%= lang.infoMessages.noRequest %>
			</div>
		
		<% } %>
		<!-- /Interventions List -->

	</div>
	<!-- /Left Column -->




	<!-- Right Column -->
	<div class="span9">


		<!-- List Officer/Teams -->
		<div id="listAgentsTeams">
			<ul class="nav nav-tabs" id="allTabs">
				<li class="active">
					<a href="#" data-target="#tab-agents" data-toggle="tab" class="no-outline">
						<%= _.capitalize(lang.agents) %> &nbsp;<span class="badge"><%= _.size(officers) %></span>
					</a>
				</li>
				<li>
					<a href="#" data-target="#tab-teams" data-toggle="tab" class="no-outline">
						<%= _.capitalize(lang.teams) %> &nbsp;<span class="badge"><%= _.size(teams) %></span>
					</a>
				</li>
			</ul>

			<div class="tab-content">
				
				<!-- Officers -->
				<div class="tab-pane active" id="tab-agents">
					<ul id="listAgents" class="unstyled inline nav nav-list">
						<%_.each(officers, function (officer, i) { console.log(officer); %>
							<li>
								<a id="pOfficer_<%= officer.id %>" href="#planning/<%= _.slugify(officer.name)%>">
									<i class="icon-user"></i><%= (officer.firstname != false ? officer.firstname : '') %> &nbsp;<%= officer.name.toUpperCase() %>
								</a>
							</li>
						<% }) %>
					</ul>
				</div>

				<!-- Teams -->
				<div class="tab-pane" id="tab-teams">
					<ul id="listTeams" class="unstyled inline nav nav-list">
						<% _.each(teams, function (team, i) {

							var teamMembers = "<li><i class='icon-asterisk'></i> "+ team.manager_id[1] +"</li>";

							_.each(team.members, function(teamMember){
								teamMembers += "<li><i class='icon-user'></i>&nbsp;"+ (teamMember.firstname != false ? teamMember.firstname.replace(' ', '&nbsp;') : '') +"&nbsp;"+ teamMember.name.toUpperCase().replace(' ', '&nbsp;') +"</li>"
							});
						%>

							<li rel="popover" data-original-title="<%= _.capitalize(lang.agents) %>" data-content="<ul class='unstyled'><%= teamMembers %></ul>" data-html="true" data-placement="left">
								<a id="pTeam_<%= team.id %>" href="#planning/<%= _.slugify(team.name)%>">
									<i class="icon-group"></i><%= team.name %>
								</a>
							</li>
						<% }) %>
					</ul>
				</div>


		  	</div>
		</div>
		<!-- /List Officer/Teams -->


		<!-- Calendar -->
		<div id="calendarsContainer" style="overflow: hidden; max-height: 590px;">
			<div id="calendar"></div>
		</div>
		<!-- /Calendar -->


	</div>

</div>




<!-- Modal Form Absent Task -->
<div id="modalAbsentTask" class="modal hide fade">
	<div class="modal-header">
	    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
	    <h3><%= lang.viewsTitles.newAbsent %></h3>
	</div>
	
	<div class="modal-body">

		<blockquote id="infoModalAbsentTask" class="spaceBottom">
			<p></p>
			<small></small>
		</blockquote>

	    <form id="formAbsentTask" action="#" class="form-horizontal">


	    	<!-- Absent Type -->
	    	<div class="control-group">
				<label for="absentType" class="control-label"><%= _.capitalize(lang.type) %>:</label>

				<div class="controls">
					<select id="absentType" required="required"></select>
					<span class="help-inline"></span>
				</div>
			</div>


            <!-- Absent start date / hour -->
            <div class="control-group">
				<label class="control-label" for="startDate"><%= _.capitalize(lang.dateStart) %>:</label>
				<div class="control-group">

					<div class="controls">
						<!-- Start date -->
						<div class="input-append">
							<input  type="text" class="datepicker input-small" id="startDate" value="" required="required">
							<span class="add-on"><i class="icon-calendar"></i></span>
						</div>
	                	
						<!-- Start Hour -->
						<div class="input-append bootstrap-timepicker" >							
							    <input type="text" class="timepicker-default input-mini" id='startHour' required="required">
							    <span class="add-on"><i class="icon-time"></i></span>
						</div>
					</div>

				</div>
			</div>
            

			<!-- Absent end date / hour -->
            <div class="control-group">
                <label class="control-label" for="endDate"><%= _.capitalize(lang.dateEnd) %>:</label>
                <div class="control-group">

	                <div class="controls">
	            		<!-- End Date -->
	            		<div class="input-append">
	                        <input type="text" class="datepicker input-small" id="endDate" value=""  placeholder="dd/mm/yyyy" required="required">
	                    	<span class="add-on"><i class="icon-calendar"></i></span>
	                    </div>

	                    <!-- End Hour -->
	                    <div class="input-append bootstrap-timepicker" >							
						    <input type="text" class="timepicker-default input-mini" id='endHour' required="required">
						    <span class="add-on"><i class="icon-time"></i></span>
						</div>
	                </div>

            	</div>
            </div>
          
	    </form>
	</div>
	
	<div class="modal-footer">
	    <button type="submit" form="formAbsentTask" class="btn btn-primary okButton" id="okButton"><%= _.capitalize(lang.actions.save) %></button>&nbsp;&nbsp;
	    <a href="#" data-dismiss="modal" class='dismiss'><%= _.capitalize(lang.actions.cancel) %></a>
	</div>
</div>



<!-- Modal Form Cancel Intervention -->
<div id="modalCancelInter" class="modal hide fade">
	<div class="modal-header">
	    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
	    <h3><%= lang.viewsTitles.cancelIntervention %></h3>
	</div>
	
	<div class="modal-body">

		<blockquote id="infoModalCancelInter" class="spaceBottom">
			<p></p>
			<small></small>
		</blockquote>

	    <form id="formCancelInter" action="#" class="form-horizontal">

			<!-- Intervention refusal reason -->
            <div class="control-group">
                <label for="motifCancel" class="control-label"><%= _.capitalize(lang.reason) %>:</label>

                <div class="controls">
                    <textarea id="motifCancel" rows="5" required="required"></textarea>
                    <span class="help-inline"></span>
                </div>
            </div>
	    </form>
	</div>
	
	<div class="modal-footer">
	    <button type="submit" form="formCancelInter" class="btn btn-primary"><%= _.capitalize(lang.actions.save) %></button>&nbsp;&nbsp;
	    <a href="#" data-dismiss="modal"><%= _.capitalize(lang.actions.cancel) %></a>
	</div>
</div>



<!-- Modal Form Delete Task -->
<div id="modalDeleteTask" class="modal hide fade">
	<div class="modal-header">
		<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
		<h3><%= lang.viewsTitles.deleteTask %></h3>
	</div>
	
	<div class="modal-body">

		<blockquote id="infoModalDeleteTask" class="spaceBottom">
			<p></p>
			<small></small>
		</blockquote>

		<p><%= lang.warningMessages.confirmDeleteTask %></p>
	</div>
	
	<div class="modal-footer">
	    <button type="button" class="btn btn-danger btnDeleteTask"><%= _.capitalize(lang.actions.delete) %></button>&nbsp;&nbsp;
	    <a href="#" data-dismiss="modal"><%= _.capitalize(lang.actions.cancel) %></a>
	</div>
</div>



<!-- Modal About the Task -->
<div id="modalAboutTask" class="modal hide fade">
	<div class="modal-header">
		<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
		<h3><%= lang.aboutTheTask %></h3>
	</div>
	
	<div class="modal-body">

		<blockquote id="infoModalAboutTask" class="spaceBottom">
			<p></p>
			<small></small>
		</blockquote>

		<!--<form class="form-horizontal" id="formModalAboutTask">

			<!-- Switch Button With Foreman -->
			<!--<div class="control-group">
				<label class="control-label" for="withForeman"><%= _.capitalize(lang.withForeman) %>:</label>

				<div class="controls">
            		<div id="switchWithForeman" class="switch switch-small" data-on-label="<i class='icon-ok'></i>" data-off-label="<i class='icon-remove'></i>" data-on="success" data-off="warning">
                		<input id="withForeman" type="checkbox" />
            		</div>
        		</div>
			</div>
	    </form>-->

	</div>

	<div class="modal-footer">
	    <button type="button" id="btnRemoveTask" class="btn btn-danger"><%= _.capitalize(lang.actions.removeOfTheSchedule) %></button>&nbsp;&nbsp;
	    <a href="#" data-dismiss="modal"><%= _.capitalize(lang.actions.cancel) %></a>
	</div>
</div>



<!-- Form to add a new Task -->
<div id="modalAddTask" class="modal hide fade">
	<div class="modal-header">
		<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
		<h3><%= _.capitalize(lang.actions.addTask) %></h3>
	</div>

	<div class="modal-body">
		<form id="formAddTask" action="#" class="form-horizontal">

			<!-- Task name -->
			<div class="control-group">
				<label for="taskName" class="control-label"><%= _.capitalize(lang.label) %>:</label>

				<div class="controls">
					<input type="text" id="taskName" name="taskName" required="required"/>
					<span class="help-inline"></span>
				</div>
			</div>

			<!-- Task hour -->
			<div class="control-group">
				<label for="taskHour" class="control-label"><%= _.capitalize(lang.estimatedHours) %>:</label>

				<div class="controls">
					<div class="input-append bootstrap-timepicker" >							
						<input type="text" value="01:00" class="timepicker-default input-mini" id='taskHour' required="required">
						<span class="add-on"><i class="icon-time"></i></span>
					</div>
				</div>
			</div>

			<!-- Task Category -->
			<div class="control-group">
				<label for="taskCategory" class="control-label"><%= _.capitalize(lang.category) %>:</label>

				<div class="controls">
					<select id="taskCategory"></select>
					<span class="help-inline"></span>
				</div>
			</div>

	    </form>
	</div>
	
	<div class="modal-footer">
	    <button type="submit" form="formAddTask" class="btn btn-primary"><%= _.capitalize(lang.actions.save) %></button>&nbsp;&nbsp;
	    <a href="#" data-dismiss="modal"><%= _.capitalize(lang.actions.cancel) %></a>
	</div>
</div>


<!-- Form to add a new Intervention -->
<div id="modalAddInter" class="modal hide fade">
	<div class="modal-header">
		<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
		<h3><%= _.capitalize(lang.actions.addIntervention) %></h3>
	</div>
	
	<div class="modal-body">
		<form id="formAddIntervention" action="#" class="form-horizontal">

				<!-- intervention Name -->
				<div class="control-group">
					<label for="interventionName" class="control-label"><%= _.capitalize(lang.label) %>:</label>

					<div class="controls">
					    <input type="text" id="interventionName" name="interventionName" required="required" />
					    <span class="help-inline"></span>
					</div>
                    
                    <div class="controls">
						<label for="isTemplate" class="checkbox"><%= _.capitalize(lang.template) %>
							<input type="checkbox" id="isTemplate" />
						</label>
					</div>
                </div>
                
                <!-- intervention Description -->
                <div class="control-group">
                    <label for="interventionDescription" class="control-label"><%= _.capitalize(lang.description) %>:</label>

                    <div class="controls">
                        <textarea name="interventionDescription" id="interventionDescription" rows="5" required="required"></textarea>
                        <span class="help-inline"></span>
                    </div>
                </div>
                
                <!-- intervention Contact Service -->
                <div class="control-group">
                    <label for="interventionDetailService" class="control-label"><%= lang.serviceConcerned %>:</label>

                    <div class="controls">
                        <select id="interventionDetailService"></select>
                        <span class="help-inline"></span>
                    </div>
                </div>
                
                <!-- intervention Place -->
                <div class="control-group">
                    <label for="interventionPlace" class="control-label"><%= _.capitalize(lang.place) %>:</label>

                    <div class="controls">  
                        <select id="interventionPlace"><option value="" disabled="disabled" ></option></select>
                        <span class="help-inline"></span>                           
                    </div>
                </div>
                
                <!-- intervention Place precision -->
                <div class="control-group">
                    <label for="interventionPlacePrecision" class="control-label"><%= _.capitalize(lang.informationOfTheSite) %>:</label>

                    <div class="controls">  
                         <textarea name="interventionPlacePrecision" id="interventionPlacePrecision" rows="2"></textarea>
                        <span class="help-inline"></span>                           
                    </div>
                </div>

	    </form>
	</div>
	
	<div class="modal-footer">
	    <button type="submit" form="formAddIntervention" class="btn btn-primary"><%= _.capitalize(lang.actions.save) %></button>&nbsp;&nbsp;
	    <a href="#" data-dismiss="modal"><%= _.capitalize(lang.actions.cancel) %></a>
	</div>
</div>
<div id="printingCalendar"></div>




<!-- Form to print paperboard-->
<div id="printContainer" class="hide container-fluid printContainer" >

	<!-- <table cellpadding="0" cellspacing="0" border="0" class="bordered-table zebra-striped" id="example">  -->
	<!--  <table  class="table table-striped table-bordered" border="1" id="example" width="100%"> -->
    <div>
    	<div class="top">
    		<div class="dataTables_info" id="example_info">
    			<h1>Fiche d'interventions: <em id="worker"></em></h1>	
   				
    		</div>
    		<div class="dataTables_filter" id="example_filter">
    			<img src="css/images/administration_logo.png" />
    		</div>
    		<div id="example_length" class="dataTables_length">
    			<h2>
    				<span class="before-muted"></span>
					<em class="muted"></em>
				</h2>    			
    		</div>
    		<div class="dataTables_paginate paging_two_button" id="example_paginate">
    		</div>
    		<div class="clear"></div>
    	</div>

		<table class="dataTables dataTables_wrapper" id="paperboard">
			<thead class="top">
				<tr>
					<th>Day</th>
					<th><%= _.capitalize(lang.intervention) %></th>
					<th><%= _.capitalize(lang.description) %></th>
					<th><%= _.capitalize(lang.label) %></th>
					<th><%= _.capitalize(lang.place) %></th>
					<th>Heure début fin</th>
					<th><%= _.capitalize(lang.estimatedHours) %></th>
					<th><%= _.capitalize(lang.spentHours) %></th>
					<th><%= _.capitalize(lang.remainingHours) %> <!--Temps restant estimé par l'agent--></th>
					<th><%= _.capitalize(lang.done) %></th>
					<th><%= _.capitalize(lang.materialEquipment) %> / <%= _.capitalize(lang.vehicleEquipment) %></th>
					<th><%= _.capitalize(lang.oilQtity) %></th>
					<th><%= _.capitalize(lang.km) %></th>
					<th><%= _.capitalize(lang.oilPrice) %></th>
				</tr>
			</thead>
		</table>

	</div>
</div>
