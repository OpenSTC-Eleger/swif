<!-- Check the group of the user to display element with the good color -->	
<% 
	if(app.models.user.isDST()) { 
		var classColor = "warning";
		var actionRequestToProcess = lang.actions.confirm;
	}
	else if(app.models.user.isManager()){
		var classColor = "info";
		var actionRequestToProcess = lang.actions.process;
	}
	else{ 
		var classColor = "";
		var actionRequestToProcess = "";
	} 
%>



<div class="page-header">
	<h1>
		<%= lang.viewsTitles.requestsList %>
		<sup rel="tooltip" data-original-title="<%= actionRequestToProcess %>">
			<i class="badge badge-<%= classColor %>" >
				<%= nbInterventionsInBadge %>
			</i>
		</sup>
	</h1>
</div>


<div class="container-fluid">

	<!-- Message if No Request to Display -->
	<% if(requests.length == 0) { %>
		<div class="tableToolbar">
			<br>

			<div class="alert alert-info">
				<i class="icon-info-sign icon-large"></i> &nbsp;<%= lang.infoMessages.noRequest %>.
			</div>
		</div>
	<% } %>


		<!-- Table toolbar -->
		<div class="tableToolbar">
			<a href="#demandes-dinterventions/add" class="btn btn-primary"><i class="icon-plus-sign"></i> <%= _.capitalize(lang.actions.addRequest) %></a>

			<form class="form-search pull-right">
    			<div class="input-append">
					<input type="search" class="input-medium search-query" disabled="disabled" placeholder="<%= lang.actions.search %>..." autocomplete="off">
					<button type="submit" class="btn disabled"><i class="icon-search icon-large"></i></button>
				</div>
			</form>
		</div>
		<!-- Table toolbar -->


		<!-- Table Requests -->
		<table class="table table-striped table-bordered table-hover">
			<thead>
				<tr>
					<th><%= _.capitalize(lang.label) %></th>
					<th class="hidden-phone"><%= _.capitalize(lang.place) %></th>
					<th><%= _.capitalize(lang.service) %></th>
					<th><%= _.capitalize(lang.claiment) %></th>
					<th><%= _.capitalize(lang.dateRequest) %> <!--<a id="orderDateRequest" href="#" class="pull-right"><i class="icon-caret-down icon-large"></i></a>--></th>
					<th>
						<%= _.capitalize(lang.status) %> 
						<div class="dropdown pull-right">
						    <a id="filterStateRequest" class="dropdown-toggle filter-button" data-toggle="dropdown" href="#"><i class="icon-filter icon-large"></i></a>
						    
						    <ul id="filterStateRequestList" class="dropdown-menu" role="menu" aria-labelledby="filterStateRequest">
								<% _.each(requestsState, function (state, i) { %>
									<li role="menuitem">
										<a tabindex="-1" href="#<%= state.value %>"> 
											<i class="badge <%= (state.color != '' ? 'badge-'+state.color : '') %>">&nbsp;</i>
											&nbsp; <%= _.capitalize(state.traduction) %>
										</a>
									</li>
								<% }) %>
									<li class="divider"></li>
									<li class="delete-filter disabled"><a href="#delete-filter"><%= _.capitalize(lang.deleteFilter) %></a></li>
							</ul>
						</div>
					</th>
					
					<% if(app.models.user.isDST() || app.models.user.isManager()){ %>
						<th><%= _.capitalize(lang.action) %></th>
					<% } %>
				</tr>
			</thead>

		<!-- Check if there is Request in the Database -->
		<% if(requests.length != 0) { %>

			<tbody>
				<% for (var i = startPos; i < endPos; i++) { %>
				
					<!-- Set if the table row should be hightlight and Bold -->
					<% if(requests[i].state == app.Models.Request.state[1].value && app.models.user.isManager()) {
						var classRow = classColor+" bolder";
					}
					else if(requests[i].state == app.Models.Request.state[2].value && app.models.user.isDST()){
						var classRow = classColor+" bolder";
					}
					else{
						var classRow = "";
					}
					var description = (requests[i].description != '' ? requests[i].description : _.capitalize(lang.notKnown))
					var createdBy = (requests[i].create_uid != ''  
										?_.capitalize(lang.createdBy) + requests[i].create_uid[1] 
										: "")
					var modifydBy = (requests[i].write_uid != ''  
										?_.capitalize(lang.modifyBy) + requests[i].write_uid[1] 
										: "")
					%>

					<tr id="<%= i %>" class="<%= classRow %>">
					    <td>
					    	<a 	href="#demandes-dinterventions/<%= requests[i].id %>" 
								rel="popover" 
								data-content="<%=  description + '\n(' + createdBy +')' %>"
								data-original-title="<%= _.capitalize(lang.description)  %>:">
								<%= _.capitalize(requests[i].name) %>
							</a>
						</td>
						<td><%= (requests[i].site1 != false ? _(requests[i].site1[1].toLowerCase()).titleize() : "") %></td>
						<td class="hidden-phone">
					    	<span 
					    		rel="tooltip"
					    		data-original-title="<%= _.capitalize(lang.toValidateBy) %> <%= (requests[i].manager_id != false ? requests[i].manager_id[1] : _.capitalize(lang.notKnown)) %>">
					    		<!--  <%= requests[i].service_id[1] %>  -->
					    		<%= requests[i].belongsToService!=null?requests[i].belongsToService.name:"" %>
					    	</span>
					    </td>
					    <td><%= requests[i].partner_id[1] %></td>
					    <td>
							<span 
					    		rel="tooltip"
					    		data-original-title="<%= moment(requests[i].create_date, 'YYYY-MM-DD HH:mm:ss').add('hours',1).fromNow() %>">
					    		<%= ( requests[i].create_date != null &&  requests[i].create_date != "" ) ? moment(requests[i].create_date, 'YYYY-MM-DD HH:mm:ss').add('hours',1).format('LLL'): "" %>
					    	</span>
					    </td>
					    <td>
				    		<% if(requests[i].state == app.Models.Request.state[0].value) { %> 
				    			<span class="label label-important" 
				    				rel="tooltip"
					    			data-original-title="<%= requests[i].refusal_reason  +'\n('+ modifydBy +')'%>">
					    			<%= lang.refused %>
					    		</span>
				    		<% } else if(requests[i].state == app.Models.Request.state[1].value) { %>
				    			<span class="label label-info"><%= lang.wait %></span>
				    		<% } else if(requests[i].state == app.Models.Request.state[2].value) { %>
				    			<span class="label label-warning"><%= lang.confirm %></span>
				    		<% } else if(requests[i].state == app.Models.Request.state[3].value) { %>
				    			<span class="label label-success"				    				
				    				rel="tooltip"
									data-original-title="<%= requests[i].infoMessage %>">
					    			<%= lang.valid %>
					    		</span>
				    		<% } else if(requests[i].state == app.Models.Request.state[4].value) { %>
				    			<span class="label label"><%= lang.closed %></span>
				    		<% } %>
					   	</td>
					   	
					   	<% if((app.models.user.isDST() || app.models.user.isManager())
					   			&& requests[i].intervention_ids.length == 0){ %>
						   	<td class="align">

						   		<!-- Refused State -->
								<% if(requests[i].state == app.Models.Request.state[0].value) { %>
						   		
									<div class="btn-group">
										<button class="btn btn-small disabled no-outline"><i class="icon-remove text-error"></i></button>
										<button class="btn btn-small dropdown-toggle no-outline" data-toggle="dropdown">
											<span class="caret"></span>
										</button>
										<ul class="dropdown-menu pull-right align-left">
											<li><a href="#modalValidRequest" data-toggle="modal" class="buttonValidRequest"><i class="icon-ok text-sucess"></i>&nbsp;Valider</a></li>
											<% if(!app.models.user.isDST()){ %>
												<li><a href="#modalConfirmDSTRequest" data-toggle="modal" class="buttonConfirmDST"><i class="icon-user"></i>&nbsp;Remonter DST</a></li>
											<% } %>
										</ul>
									</div>

								<!-- Wait state -->
								<% } else if(requests[i].state == app.Models.Request.state[1].value) { %>
									
									<div class="btn-group">
										<button class="btn btn-small btn-success no-outline buttonValidRequest" data-toggle="modal" data-target="#modalValidRequest"><i class="icon-ok buttonValidRequest"></i></button>
										<button class="btn btn-small dropdown-toggle no-outline" data-toggle="dropdown">
											<span class="caret"></span>
										</button>
										<ul class="dropdown-menu pull-right align-left">
											<li><a href="#modalRefuseRequest" data-toggle="modal" class="buttonRefuseRequest"><i class="icon-remove"></i>&nbsp;Refuser</a></li>
											<% if(!app.models.user.isDST()){ %>
												<li><a href="#modalConfirmDSTRequest" data-toggle="modal" class="buttonConfirmDST"><i class="icon-user"></i>&nbsp;Remonter DST</a></li>
											<% } %>
										</ul>
									</div>

								<!-- Confirm state -->
								<% } else if(requests[i].state == app.Models.Request.state[2].value) { %>
									
									<div class="btn-group">
										<button class="btn btn-small btn-success no-outline buttonValidRequest" data-toggle="modal" data-target="#modalValidRequest"><i class="icon-ok buttonValidRequest"></i></button>
										<button class="btn btn-small dropdown-toggle no-outline" data-toggle="dropdown">
											<span class="caret"></span>
										</button>
										<ul class="dropdown-menu pull-right align-left">
											<li><a href="#modalRefuseRequest" data-toggle="modal" class="buttonRefuseRequest"><i class="icon-remove"></i>&nbsp;Refuser</a></li>
										</ul>
									</div>

								<!-- Valid State -->
						   		<% } else if(requests[i].state == app.Models.Request.state[3].value) { %>
						   		
									<div class="btn-group">
										<button class="btn btn-small disabled no-outline"><i class="icon-ok text-success"></i></button>
										<button class="btn btn-small dropdown-toggle no-outline" data-toggle="dropdown">
											<span class="caret"></span>
										</button>
										<ul class="dropdown-menu pull-right align-left">
											<li><a href="#modalRefuseRequest" data-toggle="modal" class="buttonRefuseRequest"><i class="icon-remove"></i>&nbsp;Refuser</a></li>
											<% if(!app.models.user.isDST()){ %>
												<li><a href="#modalConfirmDSTRequest" data-toggle="modal" class="buttonConfirmDST"><i class="icon-user"></i>&nbsp;Remonter DST</a></li>
											<% } %>
										</ul>										
									</div>
									
						   		<% } else { %>
					   				<span class="text-warning" >
										<%= _.capitalize(lang.closed) %>
									</span>
						   		<% } %>
						   	</td>
							<% } else { %>
								<td>
				   					<!-- <span class="text-warning"> 
										<%= _.capitalize(lang.pending) %>
									</span> -->
					   			</td>
				   		<% } %>
					</tr>
				<% } %>
			</tbody>
			<% } %>

		</table>
		<!-- /Table Requests -->


		<!-- Table pagination -->
		<div class="pagination pagination-right">
			<ul>
				<!-- First page button -->
				<% if(page-2 >= 1){ %>
					<li <%= ((page - 1) == 0 ? " class='disabled'" : "")%>><a href='#demandes-dinterventions/page<%= 1 %>'><%= _.capitalize(lang.actions.first) %></a></li>
				<% } %>
				
				<!-- Previous page button -->
				<li <%= ((page - 1) == 0 ? " class='disabled'" : "")%>><a href='#demandes-dinterventions/page<%=(page-1)%>'><%= _.capitalize(lang.actions.previousShort) %></a></li>
			
				<!-- [...] page Button -->
				<% 	if (page-2 > 1) { %>
						<li class="disabled"><a href='#'>...</a></li>
				<% } 
						
					for (var i=(page-2); i < (page+3); i++) {
						if(i >= 1 && i <= pageCount){ %>
							<li <%= (i === page ? " class='active'" : "")%>><a href='#demandes-dinterventions/page<%=i%>'><%= i %></a></li>
						<% }

					} %>
					
				<!-- [...] page Button -->
				<% if (page+2 < pageCount) { %>
					<li class="disabled"><a href='#'>...</a></li>
				<% } %>
				
				<!-- Next page button -->
				<li <%= ((page + 1) > pageCount ? " class='disabled'" : "")%>><a href='#demandes-dinterventions/page<%=(page+1)%>'><%= _.capitalize(lang.actions.nextShort) %></a></li>
				
				<!-- Last page button -->
				<% if(page+2 <= pageCount){ %>
					<li <%= ((page + 1) > pageCount ? " class='disabled'" : "")%>><a href='#demandes-dinterventions/page<%= pageCount %>'><%= _.capitalize(lang.actions.end) %></a></li>
				<% } %>
			</ul>
		</div>
		<!-- /Table pagination -->


</div>



<!-- Modal Form ton validate the Request -->
<div id="modalValidRequest" class="modal hide fade">
	<div class="modal-header">
	    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
	    <h3>Validation de la demande</h3>
	</div>
	
	<div class="modal-body">

	    <form id="formValidRequest" action="#" class="form-horizontal">
	    
			<!-- Request name -->
            <div class="control-group">
                <label for="requestName" class="control-label">Nom:</label>

                <div class="controls">
                    <input type="text" id="requestName" name="requestName" disabled="disabled" />
                    <span class="help-inline"></span>
                </div>
            </div>

            <!-- Request Assignement -->
            <div class="control-group">
                <label for="requestAssignement" class="control-label">Affectation:</label>

                <div class="controls">
                     <select id="requestAssignement" name="requestAssignement" required="required"></select>
                    <span class="help-inline"></span>
                </div>
            </div>

			<!-- Request Service -->
            <div class="control-group">
                <label for="requestService" class="control-label">Service concerné:</label>

                <div class="controls">
                      <select id="requestService" name="requestService"></select>
                    <span class="help-inline"></span>
                </div>
            </div>

			<!-- Request Deadline -->
            <div class="control-group">
                <label class="control-label" for="requestDeadline">Date butoire:</label>
                <div class="controls">
					<input class="datePicker" data-date-format="dd/mm/yyyy" id="requestDeadline" placeholder="dd/mm/yyyy" size="30" type="text" required="required">
                </div>
			</div>
           
			<!-- Request Note description  -->
            <div class="control-group">
                <label for="requestNote" class="control-label">Note:</label>

                <div class="controls">
                    <textarea id="requestNote" rows="5" required="required"></textarea>
                    <span class="help-inline"></span>
                </div>
            </div>

	    </form>
	</div>
	
	<div class="modal-footer">
	    <button type="submit" form="formValidRequest" class="btn btn-primary">Enregistrer et ajouter des tâches</button>&nbsp;&nbsp;
	    <button type="submit" form="formValidRequest" class="btn btn-primary">Enregistrer</button>&nbsp;&nbsp;
	    <a href="#" data-dismiss="modal">Annuler</a>
	</div>
</div>


<!-- Modal Form ton Refuse the Request -->
<div id="modalRefuseRequest" class="modal hide fade">
	<div class="modal-header">
	    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
	    <h3>Refus de la demande</h3>
	</div>
	
	<div class="modal-body">

		<blockquote id="infoModalRefuseRequest" class="spaceBottom">
			<p></p>
			<small></small>
		</blockquote>

	    <form id="formRefuseRequest" action="#" class="form-horizontal">
	    
			<!-- Request refuse motif -->
            <div class="control-group">
                <label for="motifRefuse" class="control-label">Motif:</label>

                <div class="controls">
                    <textarea id="motifRefuse" rows="5" required="required" placeholder="Entrée les motifs de refus de la demande"></textarea>
                    <span class="help-inline"></span>
                </div>
            </div>
	    </form>
	</div>
	
	<div class="modal-footer">
	    <button type="submit" form="formRefuseRequest" class="btn btn-primary">Enregistrer</button>&nbsp;&nbsp;
	    <a href="#" data-dismiss="modal">Annuler</a>
	</div>
</div>


<!-- Modal Form ton submit to the DST -->
<div id="modalConfirmDSTRequest" class="modal hide fade">
	<div class="modal-header">
	    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
	    <h3>Remonter la demande au DST</h3>
	</div>
	
	<div class="modal-body">

		<blockquote id="infoModalConfirmDST" class="spaceBottom">
			<p></p>
			<small></small>
		</blockquote>

	    <form id="formConfirmDSTRequest" action="#" class="form-horizontal">
	    
			<!-- Task name -->
            <div class="control-group">
                <label for="motifDST" class="control-label">Motif:</label>

                <div class="controls">
                    <textarea id="motifDST" rows="5" required="required" placeholder="Entrée les informations utiles pour le DST"></textarea>
                    <span class="help-inline"></span>
                </div>
            </div>
	    </form>
	</div>
	
	<div class="modal-footer">
	    <button type="submit" form="formConfirmDSTRequest" class="btn btn-primary">Enregistrer</button>&nbsp;&nbsp;
	    <a href="#" data-dismiss="modal">Annuler</a>
	</div>
</div>
