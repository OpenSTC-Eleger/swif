<!-- Pagination for the Week | Display the title in smart format -->
<%
	var momentDatePrev = momentDate.clone().subtract('weeks', 1).day(4);
	var momentDateNext = momentDate.clone().add('weeks', 1).day(4);


	var firstDayOfTheWeek = momentDate.clone().day(1);
	var lastDayOfTheWeek = momentDate.clone().day(7);


	if(firstDayOfTheWeek.isSame(lastDayOfTheWeek, 'month')){
		var titleFirstDay = momentDate.day(1).format('D');
	}
	else{
		if(firstDayOfTheWeek.isSame(lastDayOfTheWeek, 'year')){
			var titleFirstDay = momentDate.day(1).format('D MMM');
		}
		else{
			var titleFirstDay = momentDate.day(1).format('D MMM YYYY');
		}
	}

%>



<div class="page-header">
	<h1>
		<%= lang.viewsTitles.tasksList %>
		<sup rel="tooltip" data-original-title="<%= lang.wait %>">
			<i class="badge badge-info">
				<%= nbPendingTasks %>
			</i>
		</sup>
	</h1>
</div>


<div class="container-fluid">

	<!-- Add task -->
	<div class="tableToolbar">
		<button class="btn btn-primary btn-small no-outline addTask">
			<i class="icon-plus"></i>&nbsp; <%= _.capitalize(lang.actions.addTask) %>
		</button>
		
		
	</div>
	<!-- Add task -->

	<h2 class="align-center">
		<%= lang.week %> <%= momentDate.week() %> - 
		<em class="muted"><%= titleFirstDay %> <%= lang.to %> <%= lastDayOfTheWeek.format('D MMM YYYY') %></em>
	</h2>

	<!-- Pagination -->
	<ul class="pager noMarginTop">
		<li class="previous">
			<a href="#taches/<%= momentDatePrev.year()+"/"+momentDatePrev.week() %>"><i class="icon-chevron-left"></i> <%= _.capitalize(lang.actions.previousWeek) %></a>
		</li>
		<li class="next">
			<a href="#taches/<%= momentDateNext.year()+"/"+momentDateNext.week() %>"><%= _.capitalize(lang.actions.nextWeek) %> <i class="icon-chevron-right"></i></a>
		</li>
	</ul>

	<div class="accordion without-border">
	<!-- Check if there is Request in the Database -->
	<% 	_.each(tasksPerDay, function(day, i) { %>

		<section class="accordion-group dayTasks">
		
			<div class="accordion-heading">
				<a class="accordion-toggle" data-toggle="collapse" href="#accordion_<%= i %>">
					<h4 class="table-caption">
						<%= _.capitalize(day.day.format('dddd D MMMM')) %> 
						<small class="badge badge vertical-align-top pull-right">
							<%= _.size(day.tasks) %>
						</small>
					</h4>
				</a>
			</div>
			
			
			<!-- Unfold the current day -->
			<% if(day.day.isSame(moment(), "day")){ var unfold = 'in'; }%>	
						
			<div id="accordion_<%= i %>" class="accordion-body collapse <%= unfold %>">
			
			<!-- Check if there is tasks planned this day -->
			<% if(_.size(day.tasks) != 0){ %>

				
				<!-- Table Requests -->
				<table class="table table-striped table-bordered table-hover">
					<thead>
						<tr>
							<th><%= _.capitalize(lang.intervention) %></th>
							<th><%= _.capitalize(lang.label) %></th>
							<th><%= _.capitalize(lang.place) %></th>
							<th><%= _.capitalize(lang.startHour) %></th>
							<th><%= _.capitalize(lang.endHour) %></th>
							<th><%= _.capitalize(lang.assignedTo) %></th>
							<th class="hidden-phone"><%= _.capitalize(lang.plannedHours) %></th> 
							<th class="hidden-phone"><%= _.capitalize(lang.remainingHours) %></th>
							<th><%= _.capitalize(lang.status) %></th>
							<th><%= _.capitalize(lang.action) %></th>
						</tr>
					</thead>
					<tbody>
						
					<% _.each(day.tasks, function (task, i) { %>

						<tr id="<%= task.id %>">
						    <td><%= task.project_id[1] %></td>
					    	<td><a href="#taches/<%= task.id %>"> <%= _.capitalize(task.name) %> </a></td>
							<td><%= (task.intervention && task.intervention.site1 ) ? task.intervention.site1[1] : '' %></td>
							<td><%= (task.date_start) != '' ? moment(task.date_start).format('H[h]mm') : '' %></td>
							<td><%= (task.date_end) != '' ? moment(task.date_end).format('H[h]mm') : '' %></td>

						    <% if(task.team_id == false){ %>
						    	<td><%= task.user_id[1] %></td>
						    <% } else { %>
						    	<td><%= task.team_id[1] %></td>	
						    <% } %>

						    <td class="hidden-phone"><%= task.planned_hours %>h</td>
						    <td class="hidden-phone"><%=(task.state!=app.Models.Task.state[3].value && task.state!=app.Models.Task.state[5].value)?task.remaining_hours+'h':"" %></td>
						    <td>
					    		<% if(task.state == app.Models.Task.state[0].value) { %>
					    			<span class="label label-info"><%= lang.wait %></span>
					    		<% } else if(task.state == app.Models.Task.state[1].value) { %>
					    			<span class="label label-success"><%= lang.finished %></span>
					    		<% } else if(task.state == app.Models.Task.state[2].value) { %>
					    			<span class="label label-muted"><%= lang.pending %></span>
					    		<% } else if(task.state == app.Models.Task.state[4].value) { %> 
					    			<span class="label label-important"><%= lang.refused %></span>
					    		<% } %>
					    		
						   	</td>

						   	<!-- Actions -->
						   	<td class="align">

						   		<!-- Tâches à saisir -->
								<% if( task.state == app.Models.Task.state[0].value && task.date_start) { %>
						   		
									<div class="btn-group">
										<button class="btn btn-small btn-success no-outline buttonTaskDone" data-toggle="modal" data-taskid="<%= task.id %>" data-target="#modalTaskDone"><i class="icon-ok"></i></button>
										<button class="btn btn-small dropdown-toggle no-outline" data-toggle="dropdown">
											<span class="caret"></span>
										</button>
										<ul class="dropdown-menu pull-right align-left">										
											<li><a href="#" class="taskNotDone" data-taskid="<%= task.id %>"><i class="icon-remove"></i>&nbsp;Non Fait</a></li>
											<li><a href="#modalTimeSpent" data-toggle="modal" data-taskid="<%= task.id %>" class="buttonTimeSpent"><i class="icon-time"></i>&nbsp;Non Terminée</a></li>
										</ul>
									</div>

								<% } %>
						   	</td>
							
						</tr>
					<% }); %>
					</tbody>
				</table>
				
				<!-- /Table Requests -->

			<% } else{ %>
				<!-- No Task to Display -->
				<div class="alert alert-info">
					<i class="icon-info-sign icon-large"></i> &nbsp;<%= lang.infoMessages.noTask %>.
				</div>
			<% } %>
			</div>

		</section>
	<% }); %>
	</div>

	


		<!-- Pagination -->
		<ul class="pager">
			<li class="previous">
				<a href="#taches/<%= momentDatePrev.year()+"/"+momentDatePrev.week() %>"><i class="icon-chevron-left"></i> <%= _.capitalize(lang.actions.previousWeek) %></a>
			</li>
			<li class="next">
				<a href="#taches/<%= momentDateNext.year()+"/"+momentDateNext.week() %>"><%= _.capitalize(lang.actions.nextWeek) %> <i class="icon-chevron-right"></i></a>
			</li>
		</ul>


</div>


<!-- Modal Form Task Done -->
<div id="modalTaskDone" class="modal hide fade">
	<div class="modal-header">
	    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
	    <h3>Saisie du temps passé</h3>
	</div>
	
	<div class="modal-body custom-height-modal">

		<blockquote id="infoModalTaskDone" class="spaceBottom">
			<p></p>
			<small></small>
		</blockquote>

	    <form id="formTaskDone" action="#" class="form-inline">
	    	 <div class="input">
	    	     <div class="control-group">
	               	<label for="eventTimeDone" class="control-label">Temps travaillé:</label>
	               	<div class="controls">
						<div class="input-append bootstrap-timepicker" >							
						    <input type="text" class="timepicker-default input-small taskInput" id='eventTimeDone'>
						    <span class="add-on">
						        <i class="icon-time"></i>
						    </span>
						</div>
	               	</div>
				</div>
				
			</div>
			
			<div class="input-append">
				<!-- Equipment -->
	            <div class="control-group">
					<label for="taskEquipmentDone" class="control-label"><%= _.capitalize(lang.equipment) %>:</label>
	
					<div class="controls">
						<select id="taskEquipmentDone" class="taskEquipment taskSelect taskInput"></select>
						<span class="help-inline"></span>
					</div>
				</div>
				
				<!-- OIL -->
				<div class="control-group">
					<label for="equipmentOilQtityDone" class="control-label"><%= _.capitalize(lang.oilQtity) %>:</label>
	
					<div class="controls">
						<input type="number" id="equipmentOilQtityDone" name="equipmentOilQtityDone" class="taskInput" required="required"  min="1" />
						<span class="help-inline"></span>
					</div>
				</div>	
			
			</div>
			<div class="input-append">	
								
				<!-- KM -->
				<div class="control-group">
					<label for="equipmentKmDone" class="control-label"><%= _.capitalize(lang.km) %>:</label>
	
					<div class="controls">
						<input type="number" id="equipmentKmDone" name="equipmentKmDone" class="equipmentKm taskInput" required="required"  min="1" />
						<span class="help-inline"></span>
					</div>
				</div>	
				
				<!-- OIL_PRICE -->
				<div class="control-group">
					<label for="equipmentOilPriceDone" class="control-label"><%= _.capitalize(lang.oilPrice) %>:</label>
	
					<div class="controls">
						<input type="number" id="equipmentOilPriceDone" name="equipmentOilPriceDone" class="taskInput" required="required"  min="1" />
						<span class="help-inline"></span>
					</div>

				</div>
			</div>
			
			<!-- Select Material -->
			<div class="row-fluid marginTop equipmentsDroppableAreaDone">
				
				<div class="span6">
					<div class="widget-title">
						<h4>Matériels <span class="badge pull-right"></span></h4>
					</div>
	
					<ul id="equipmentsDone" class="sortableEquipmentsList sortable unstyled nav nav-list">
	
					</ul>
				</div>
	
				<div class="span6">
					<div class="widget-title">
						<h4>Autres matériels <span class="badge pull-right" id="badgeNbEquipmentsDone"></span></h4>
					</div>
	
					<ul id="equipmentsListDone" class="sortableEquipmentsList sortable unstyled nav nav-list">
					</ul>
				</div>
	
			</div>

	    </form>
	</div>
	
	<div class="modal-footer">
	    <button type="submit" form="formTaskDone" class="btn btn-primary">Enregistrer</button>&nbsp;&nbsp;
	    <a href="#" data-dismiss="modal">Annuler</a>
	</div>
</div>


<!-- Modal Form to Add a new Task -->
<div id="modalAddTask" class="modal hide fade">
	<div class="modal-header">
	    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
	    <h3>Nouvelle tâche</h3>
	</div>
	
	<div class="modal-body custom-height-modal">

	    <form id="formAddTask" action="#" class="form-inline ">
	    
	    	<div class="input-append">
				<!-- Task name -->
	            <div class="control-group">
	                <label for="taskName" class="control-label" >Nom:</label>
	
	                <div class="controls">
	                    <input type="text" id="taskName" name="taskName" class="taskInput"  required="required"/>
	                    <span class="help-inline"></span>
	                </div>
	            </div>
	            
	            <!-- Equipment -->
	            <div class="control-group">
					<label for="taskEquipmentAdd" class="control-label"><%= _.capitalize(lang.equipment) %>:</label>
	
					<div class="controls">
						<select id="taskEquipmentAdd" class="taskEquipment taskInput taskSelect"></select>
						<span class="help-inline"></span>
					</div>
				</div> 
				
				<!-- OIL -->
				<div class="control-group">
					<label for="equipmentOilQtityAdd" class="control-label"><%= _.capitalize(lang.oilQtity) %>:</label>
	
					<div class="controls">
						<input type="number" id="equipmentOilQtityAdd" name="equipmentOilQtityAdd" class="taskInput"  required="required"  min="1" />
						<span class="help-inline"></span>
					</div>

				</div>
	      	</div>    
	      
	      	<div class="input-append">
			
				<!-- Task Category -->
	            <div class="control-group">
	                <label for="taskCategory" class="control-label">Catégorie:</label>
	
	                <div class="controls">
	                     <select id="taskCategory" class="taskInput taskSelect"></select>
	                    <span class="help-inline"></span>
	                </div>
	            </div>
							
				<!-- KM -->
				<div class="control-group">
					<label for="equipmentKmAdd" class="control-label"><%= _.capitalize(lang.km) %>:</label>
	
					<div class="controls">
						<input type="number" id="equipmentKmAdd" name="equipmentKmAdd" class="equipmentKm taskInput" required="required"  />
						<span class="help-inline"></span>
					</div>
				</div>	
				
				<!-- OIL_PRICE -->
				<div class="control-group">
					<label for="equipmentOilPriceAdd" class="control-label"><%= _.capitalize(lang.oilPrice) %>:</label>
	
					<div class="controls">
						<input type="number" id="equipmentOilPriceAdd" name="equipmentOilPriceAdd" class="taskInput"  required="required"  min="1" />
						<span class="help-inline"></span>
					</div>
				</div>			
			
			</div>
			
			
			<div class="input-append">
             
             	 <div class="control-group">
                    <label class="control-label" for="startDate"><%= _.capitalize(lang.dateStart) %>:</label>
                   <div class="controls">
                        <input 
                        	type="text"
                            class="datepicker taskInput" 
                            id="startDate" 
                            size="20"
                            value="" 
                            required="required">
                        <span class="add-on"><i class="icon-calendar"></i></span>
                    </div>
                </div>
                
                <div class="control-group">
                    <label class="control-label" for="endDate"><%= _.capitalize(lang.dateEnd) %>:</label>
                    <div class="controls">
                        <input 
                        	type="text"
                            class="datepicker taskInput" 
                            id="endDate"
                            size="20" 
                            value="" 
                            placeholder="dd/mm/yyyy"
                            required="required">
                        <span class="add-on"><i class="icon-calendar"></i></span>
                    </div>
                </div>
                
            </div>  
            
            <div class="input-append">
            
            	<div class="control-group">
                	<label for="startHour" class="control-label">@</label>
                	<div class="controls">
						<div class="input-append bootstrap-timepicker" >							
						    <input type="text" class="timepicker-default input-small taskInput" id='startHour' required="required">
						    <span class="add-on">
						        <i class="icon-time"></i>
						    </span>
						</div>
                	</div>
				</div>
             
             	<div class="control-group">
                	<label for="endHour" class="control-label">@</label>
                	<div class="controls">
						<div class="input-append bootstrap-timepicker" >							
						    <input type="text" class="timepicker-default input-small taskInput" id='endHour' required="required">
						    <span class="add-on">
						        <i class="icon-time"></i>
						    </span>
						</div>
                	</div>
				</div> 
			</div> 
			
			<!-- Select Material -->
			<div class="row-fluid marginTop equipmentsDroppableAreaAdd">
				
				<div class="span6">
					<div class="widget-title">
						<h4>Matériels <span class="badge pull-right"></span></h4>
					</div>
	
					<ul id="equipmentsAdd" class="sortableEquipmentsList sortable unstyled nav nav-list">
	
					</ul>
				</div>
	
				<div class="span6">
					<div class="widget-title">
						<h4>Autres matériels <span class="badge pull-right" id="badgeNbEquipmentsAdd"></span></h4>
					</div>
	
					<ul id="equipmentsListAdd" class="sortableEquipmentsList sortable unstyled nav nav-list">
					</ul>
				</div>
	
			</div>
			
			
	    </form>
	</div>
	
	<div class="modal-footer">
	    <button type="submit" form="formAddTask"  class="btn btn-primary">Enregistrer</button>&nbsp;&nbsp;
	    <a href="#" data-dismiss="modal">Annuler</a>
	</div>
</div>


<!-- Modal Form Time Spent -->
<div id="modalTimeSpent" class="modal hide fade">
	<div class="modal-header">
	    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
	    <h3>Saisie des temps passés</h3>
	</div>
	
	<div class="modal-body custom-height-modal">

		<blockquote id="infoModalTimeSpent" class="spaceBottom">
			<p></p>
			<small></small>
		</blockquote>

	    <form id="formTimeSpent" action="#" class="form-inline">
	    
			<!-- Task name -->
             <div class="input-append">   
	             <div class="control-group">
	               	<label for="eventTimeSpent" class="control-label">Temps travaillé:</label>
	               	<div class="controls">
						<div class="input-append bootstrap-timepicker" >							
						    <input type="text" class="timepicker-default input-small" id='eventTimeSpent' class="taskInput" class="taskInput"  required="required">
						    <span class="add-on">
						        <i class="icon-time"></i>
						    </span>
						</div>
	               	</div>
				</div>

				<!-- Equipment -->
				<div class="control-group">
					<label for="taskEquipmentSpent" class="control-label"><%= _.capitalize(lang.equipment) %>:</label>
	
					<div class="controls">
						<select id="taskEquipmentSpent" class="taskEquipment taskInput taskSelect" ></select>
						<span class="help-inline"></span>
					</div>
				</div> 	
				
				<!-- OIL -->
				<div class="control-group">
					<label for="equipmentOilQtitySpent" class="control-label"><%= _.capitalize(lang.oilQtity) %>:</label>
	
					<div class="controls">
						<input type="number" id="equipmentOilQtitySpent" name="equipmentOilQtitySpent" class="taskInput" required="required"  min="1" />
						<span class="help-inline"></span>
					</div>
				</div>	
			</div>
			
			
			<div class="input-append">
			
				<div class="control-group">
	               	<label for="eventTimeRemaining" class="control-label">Temps restant:</label>
	               	<div class="controls">
						<div class="input-append bootstrap-timepicker" >							
						    <input type="text" class="timepicker-default input-small" id='eventTimeRemaining' class="eventInput" required="required">
						    <span class="add-on">
						        <i class="icon-time"></i>
						    </span>
						</div>
	               	</div>
				</div>	
	
  
				<!-- KM -->
				<div class="control-group">
					<label for="equipmentKmSpent" class="control-label"><%= _.capitalize(lang.km) %>:</label>
	
					<div class="controls">
						<input type="number" id="equipmentKmSpent" name="equipmentKmSpent" class="equipmentKm taskInput" required="required"  min="1" />
						<span class="help-inline"></span>
					</div>
				</div>	
				
				<!-- OIL_PRICE -->
				<div class="control-group">
					<label for="equipmentOilPriceSpent" class="control-label"><%= _.capitalize(lang.oilPrice) %>:</label>
	
					<div class="controls">
						<input type="number" id="equipmentOilPriceSpent" name="equipmentOilPriceSpent" class="taskInput" required="required"  min="1" />
						<span class="help-inline"></span>
					</div>
				</div>	
			</div>


			<!-- Select Material -->
			<div class="row-fluid marginTop equipmentsDroppableAreaSpent">
				
				<div class="span6">
					<div class="widget-title">
						<h4>Matériels <span class="badge pull-right"></span></h4>
					</div>
	
					<ul id="equipmentsSpent" class="sortableEquipmentsList sortable unstyled nav nav-list">
	
					</ul>
				</div>
	
				<div class="span6">
					<div class="widget-title">
						<h4>Autres matériels <span class="badge pull-right" id="badgeNbEquipmentsSpent"></span></h4>
					</div>
	
					<ul id="equipmentsListSpent" class="sortableEquipmentsList sortable unstyled nav nav-list">
					</ul>
				</div>
	
			</div>
			
				
	    </form>
	</div>
	
	<div class="modal-footer">
	    <button type="submit" form="formTimeSpent" class="btn btn-primary">Enregistrer</button>&nbsp;&nbsp;
	    <a href="#" data-dismiss="modal">Annuler</a>
	</div>
</div>
