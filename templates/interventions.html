<div class="page-header">
	<h1>
		<%= lang.viewsTitles.interventionsMonitoring %>
		<sup rel="tooltip" data-original-title="<%= lang.planningFenced %>" data-placement="right">
			<i class="badge badge-info" ><%= nbInterventionsPlanned %></i>
		</sup>

		<sup rel="tooltip" data-original-title="<%= lang.pending %>" data-placement="right">
			<i class="badge" >
				<%= nbInterventionsPending %>
			</i>
		</sup>
	</h1>
</div>


<div class="container-fluid">

	<!-- Check if there is Request in the Database -->
	<% if(interventions.length != 0) { %>

		<!-- Table toolbar -->
		<div class="tableToolbar">
			<a href="#interventions/add" class="btn btn-primary"><i class="icon-plus"></i> <%= _.capitalize(lang.actions.addIntervention) %></a>	

			<form class="form-search pull-right">
				<div class="input-append">
					<input type="search" class="input-medium search-query" disabled="disabled" placeholder="<%= lang.actions.search %>..." autocomplete="off">
					<button type="submit" class="btn disabled"><i class="icon-search icon-large"></i></button>
				</div>
			</form>
		</div>
		<!-- Table toolbar -->


		<!-- Table Interventions -->
		<table class="table-interventions table table-bordered table-hover">
			<thead>
				<tr>
					<th><%= _.capitalize(lang.label) %></th>
					<th><%= _.capitalize(lang.place) %></th>
					<th><%= _.capitalize(lang.plannedHours) %></th>
					<th><%= _.capitalize(lang.spentHours) %></th>
					<th class="span3"><%= _.capitalize(lang.progressRate) %>
						<!-- Status Filter -->
						<div class="dropdown pull-right">
							<a id="filterStateInter" class="dropdown-toggle" data-toggle="dropdown" href="#"><i class="icon-filter icon-large muted"></i></a>

							<ul id="filterStateInterList" class="dropdown-menu" role="menu" aria-labelledby="filterStateInter">
								<% _.each(interventionsState, function (state, i) { 
									if(i == 5){ %>
										<li class="divider"></li>
								<% } %>
									
									<li role="menuitem">
										<a tabindex="-1" href="#filter_<%= state.value %>"> 
											<i class="badge <%= (state.color != '' ? 'badge-'+state.color : '') %>">&nbsp;</i>
											&nbsp; <%= _.capitalize(state.traduction) %>
										</a>
									</li>

								<% }) %>

									<li role="menuitem">
										<a href="#filter_overrun">
										<i class="badge badge-overrun">&nbsp;</i>
										&nbsp;<%= _.capitalize(lang.overrun) %></a>
									</li>
									<li class="divider"></li>
									<li class="delete-filter disabled"><a href="#delete-filter"> <i class="icon-remove"></i> <%= _.capitalize(lang.deleteFilter) %></a></li>
							</ul>
						</div>
					</th>
				</tr>
			</thead>
			<tbody>
			<% _.each(interventions, function (intervention, i) { 
				%>

				<!-- Intervention row -->
				<tr class="row-object" id="inter_<%= intervention.id %>">
					<td>
						<a class="accordion-object" href="#collapse_<%= intervention.id %>">
							<i class="icon-pushpin">&nbsp;&nbsp;</i><%= _.capitalize(intervention.name) %>
						</a>
						<span class="object-actions invisible">
							<a href="#interventions/<%= intervention.id %>"><i class="icon-pencil icon-large"></i>&nbsp;<%= _.capitalize(lang.actions.update) %></a>&nbsp;&nbsp;
							<% if(intervention.state == app.Models.Intervention.state[1].value || intervention.state == app.Models.Intervention.state[0].value) { %>
								<a href="#modalCancelInter" class="buttonCancelInter" data-toggle="modal"><i class="icon-remove icon-large"></i>&nbsp;<%= _.capitalize(lang.actions.cancel) %></a> 
							<% } %>
						</span>
					</td>
					<td><%=intervention.site1[1]%></td>
					<td><%= (intervention.planned_hours != false ? app.decimalNumberToTime(intervention.planned_hours) : '') %></td>
					<td><%= (intervention.effective_hours != false ? app.decimalNumberToTime(intervention.effective_hours) : '') %></td>


					<!-- Check the state of the intervention -->
					<td>

						<!-- state - To Scheduled -->
						<% if(intervention.state == app.Models.Intervention.state[1].value){ %>
							<span class="label label-<%= app.Models.Intervention.state[1].color %>"  rel="tooltip" data-original-title="<%= intervention.infoMessage %>">
								<%= app.Models.Intervention.state[1].traduction %>
							</span>

						<!-- state - Scheduled -->
						<% } else if(intervention.state == app.Models.Intervention.state[0].value){ %>
							<span class="label label-<%= app.Models.Intervention.state[0].color %>"  rel="tooltip" data-original-title="<%= intervention.infoMessage %>">
								<%= app.Models.Intervention.state[0].traduction %>
							</span>

						<!-- state - Pending -->
						<% } else if(intervention.state == app.Models.Intervention.state[3].value){ %>
							<div class="progress progress-default" rel="tooltip" data-title="<%= intervention.infoMessage %>">
								<div class="bar" style="width: <%= intervention.progress_rate %>%"><%= _(intervention.progress_rate).toNumber() %>%</div>
							</div>

						<!-- state - Closed -->
						<% } else if(intervention.state == app.Models.Intervention.state[2].value){ 
							if(intervention.overPourcent > 100){ %>
								<div class="progress progress-overrun">
									<div class="bar" style="width: 100%"><%= _(intervention.overPourcent).toNumber() %>%</div>
								</div>
							<% } else { %>
								<div class="progress progress-success">
									<div class="bar" style="width: <%= intervention.overPourcent %>%"><%= _(intervention.overPourcent).toNumber() %>%</div>
								</div>
							<% } %>

						<!-- state - Cancelled -->
						<% } else if(intervention.state == app.Models.Intervention.state[4].value){ %>
							<span class="label label-<%= app.Models.Intervention.state[4].color %>"  rel="tooltip" data-original-title="<%= intervention.infoMessage %>">
								<%= app.Models.Intervention.state[4].traduction %>
							</span>

						<% } %>
					</td>

				</tr>

				<!-- Tasks row -->
				<tr class="row-nested-objects-collapse" id="collapse_<%= intervention.id %>">
					<td colspan="5">

						<!-- Check if there is some tasks -->
						<% if(intervention.tasks.length != 0) { %>
							<table class="table-nested-objects table table-striped table-condensed table-hover">
								<thead>
									<tr>
										<th><%= _.capitalize(lang.label) %></th>
										<th><%= _.capitalize(lang.assignedTo) %></th>									
										<th><%= _.capitalize(lang.plannedHours) %></th>
										<th><%= _.capitalize(lang.spentHours) %></th>
										<th><%= _.capitalize(lang.remainingHours) %></th>
										<th><%= _.capitalize(lang.status) %></th>
									</tr>
								</thead>
								<tbody>
									<!-- Task row -->
									<% _.each(intervention.tasks, function (task, i) { %>
										<tr class="row-nested-objects" id="task_<%= task.id %>">
											<td>
												<!-- Display a clock when the task is planned -->
												<% if(task.date_start != ''){ %>
													<i 
														class="icon-time displayInlineBlock" rel="tooltip" data-placement="top"
														data-original-title="<%= moment(task.date_start).format('LLL') %>" >
													</i>
												<% } %>
												<span class="<%= (task.state == app.Models.Task.state[1].value ? 'isCheck' : '') %>"><%= task.name %></span>&nbsp;
												<span class="nested-objects-actions invisible">
													
													<% if( task.state == app.Models.Task.state[3].value ) { %>
													
														<a href="#modalDeleteTask" class="modalDeleteTask" data-toggle="modal">
															<i class="icon-remove displayInlineBlock" rel="tooltip" data-original-title="<%= _.capitalize(lang.actions.delete) %>" data-placement="top">&nbsp;</i>
														</a>

													<% } %>
												</span>
											</td>
											<td><%= task.user_id[1] %></td>
											<td><%= app.decimalNumberToTime(task.planned_hours) %></td>
											<td><%= app.decimalNumberToTime(task.effective_hours) %></td>
											<td><%= app.decimalNumberToTime(task.remaining_hours) %></td>
											<!-- Task state -->
											<td>
												<!-- To Schedule -->
												<% if(task.state == app.Models.Task.state[3].value) { %>
														<span class="label label-<%= app.Models.Task.state[3].color %>"><%= app.Models.Task.state[3].traduction %></span>
												
												<!-- Schedule -->
												<% } else if(task.state == app.Models.Task.state[0].value){ %>
														<span class="label label-<%= app.Models.Task.state[0].color %>"><%= app.Models.Task.state[0].traduction %></span>
												
												<!-- Finish -->
												<% } else if(task.state == app.Models.Task.state[1].value){ 
														
														if(_(task.effective_hours).toNumber(2) <= _(task.planned_hours).toNumber(2)){ %>
														<span class="label label-<%= app.Models.Task.state[1].color %>"><%= app.Models.Task.state[1].traduction %></span>
														<% } else  { %>
															<span class="label label-overrun"><%= app.Models.Task.state[1].traduction %></span>
														<% } %>
												
												<!-- Cancel -->
												<% } else if(task.state == app.Models.Task.state[4].value){ %>
														<span class="label label-<%= app.Models.Task.state[4].color %>"><%= app.Models.Task.state[4].traduction %></span>
												<% } %>
											</td>
										</tr>
									<% }); %>
								</tbody>
							</table>
						<% } else { %>
								<!-- No request in the Database -->
								<div class="alert alert-info">
									<i class="icon-info-sign icon-large"></i> &nbsp;<%= lang.infoMessages.noTaskForIntervention %>.
								</div>
						<% } %>

							<div class="div-actions" >
								<button class="btn btn-primary btn-small no-outline addTask"
									<% if(intervention.state != app.Models.Intervention.state[1].value) { %>
										disabled
								<% } %>>
									<i class="icon-plus"></i>&nbsp; <%= _.capitalize(lang.actions.addTask) %>
								</button>
							</div>
					</td>
				</tr>
			<% }); %>
			</tbody>
		</table>
	<% }
	else { %>
		<div class="tableToolbar">
			<a href="#interventions/add" class="btn btn-primary"><i class="icon-plus"></i> <%= _.capitalize(lang.actions.addIntervention) %></a>
		</div>	
		<br />
		<!-- No request in the Database -->
		<div class="alert alert-info">
			<i class="icon-info-sign icon-large"></i> &nbsp;<%= lang.infoMessages.noRequestPlanned %>.
		</div>

	<% } %>

</div>



<!-- Form to add a new Task -->
<div id="modalAddTask" class="modal hide fade">
	<div class="modal-header">
	    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
	    <h3><%= _.capitalize(lang.actions.addTask) %></h3>
	</div>
	
	<div class="modal-body custom-height-modal">
		<form id="formAddTask" action="#" class="form-horizontal">

			<!-- Task name -->
            <div class="control-group">
                <label for="taskName" class="control-label">Nom:</label>

                <div class="controls">
                    <input type="text" id="taskName" name="taskName" required="required"/>
                    <span class="help-inline"></span>
                </div>
            </div>

            <!-- Task hour -->
           	<div class="control-group">
               	<label for="taskHour" class="control-label">Heures estimées:</label>
               	<div class="controls">
					<div class="input-append bootstrap-timepicker" >							
					    <input type="text" value="00:00" class="timepicker-default input-small" id='taskHour' required="required">
					    <span class="add-on">
					        <i class="icon-time"></i>
					    </span>
					</div>
				</div>
			</div>


			<!-- Task Category -->
			<div class="control-group">
				<label for="taskCategory" class="control-label">Catégorie:</label>

				<div class="controls">
					<select id="taskCategory"></select>
					<span class="help-inline"></span>
				</div>
			</div>
			
	    </form>
	</div>
	
	<div class="modal-footer">
	    <button type="submit" form="formAddTask"  class="btn btn-primary"><%= _.capitalize(lang.actions.save) %></button>&nbsp;&nbsp;
	    <a href="#" data-dismiss="modal"><%= _.capitalize(lang.actions.cancel) %></a>
	</div>
</div>



<!-- Modal Form Delete Task -->
<div id="modalDeleteTask" class="modal hide fade">
	<div class="modal-header">
	    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
	    <h3><%= lang.viewsTitles.deleteTask %></h3>
	</div>
	
	<div class="modal-body">

		<blockquote id="infoModalDeleteTask" class="spaceBottom">
			<p></p>
			<small></small>
		</blockquote>

		<p><%= lang.warningMessages.confirmDeleteTask %></p>
	</div>
	
	<div class="modal-footer">
	    <button type="button" class="btn btn-danger btnDeleteTask"><%= _.capitalize(lang.actions.delete) %></button>&nbsp;&nbsp;
	    <a href="#" data-dismiss="modal"><%= _.capitalize(lang.actions.cancel) %></a>
	</div>
</div>



<!-- Modal Form Cancel Intervention -->
<div id="modalCancelInter" class="modal hide fade">
	<div class="modal-header">
	    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
	    <h3><%= lang.viewsTitles.cancelIntervention %></h3>
	</div>
	
	<div class="modal-body">

		<blockquote id="infoModalCancelInter" class="spaceBottom">
			<p></p>
			<small></small>
		</blockquote>

	    <form id="formCancelInter" action="#" class="form-horizontal">
	    
			<!-- Request refuse motif -->
            <div class="control-group">
                <label for="motifCancel" class="control-label"><%= _.capitalize(lang.reason) %>:</label>

                <div class="controls">
                    <textarea id="motifCancel" rows="5" required="required"></textarea>
                    <span class="help-inline"></span>
                </div>
            </div>
	    </form>
	</div>
	
	<div class="modal-footer">
	    <button type="submit" form="formCancelInter" class="btn btn-primary"><%= _.capitalize(lang.actions.save) %></button>&nbsp;&nbsp;
	    <a href="#" data-dismiss="modal"><%= _.capitalize(lang.actions.cancel) %></a>
	</div>
</div>
